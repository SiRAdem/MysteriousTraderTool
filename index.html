<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EA FC Ultimate Team Coin Tracker (v2)</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Rubik', sans-serif;
      background: linear-gradient(145deg, #0f0f0f, #1f1f1f);
      color: #fff;
      padding: 20px;
      margin: 0;
    }
    #logo{
      padding:10px;
      width:300px;
      height:150px;
      position:relative;
      top:10px;
    }
    h1 {
      color: #00ff88;
      align-items: center;
      top: 0;
      background: #1a1a1a
    }
    .fancy-input, .fancy-select {
      width: 100%;
      max-width: 420px;
      margin: 9px 0 12px 0;
      padding: 13px 18px;
      font-family: inherit;
      font-size: 1.09em;
      background: linear-gradient(90deg,#232323 70%,#282c34 100%);
      color: #00ff88;
      border: 1.8px solid #00ff88;
      border-radius: 12px;
      outline: none;
      box-shadow: 0 3px 14px rgba(0,255,136,0.09);
      transition: border 0.22s, box-shadow 0.3s, background 0.2s;
      font-weight: 500;
      letter-spacing: .01em;
    }
    .fancy-input:focus, .fancy-select:focus {
      border-color: #00c96d;
      box-shadow: 0 0 14px #00ff8850;
      background: linear-gradient(90deg,#222, #00ff88 100%);
      color: #000;
    }
    .fancy-input[type="number"]::-webkit-inner-spin-button, 
    .fancy-input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .fancy-input[type="number"] {
      -moz-appearance: textfield;
    }
    ::placeholder {
      color: #4ce8aa;
      opacity: .8;
      font-weight: 400;
    }
    .input-label {
      font-size: 1em;
      color: #00ff88;
      margin-bottom: 3px;
      display: block;
      font-weight: 600;
      letter-spacing: .03em;
    }
    #selectWrapper {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 420px;
      vertical-align: middle;
      margin-bottom: 8px;
    }
    #playerRarity.fancy-select {
      appearance: none;
      background: linear-gradient(90deg, #232323, #333);
      color: #00ff88;
      border: 1.8px solid #00ff88;
      padding: 13px 40px 13px 18px;
      border-radius: 12px;
      font-size: 1.09em;
      font-family: 'Rubik', sans-serif;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,255,136,0.1);
      position: relative;
    }
    #selectWrapper:after {
      content: "‚ñº";
      position: absolute;
      right: 18px;
      top: 19px;
      color: #00ff88;
      pointer-events: none;
      font-size: 1.2em;
      z-index: 2;
    }
    button {
      background: linear-gradient(145deg, #00ff88, #00c96d);
      color: #000;
      font-weight: 700;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.22s ease;
      box-shadow: 0 4px 14px rgba(0, 255, 136, 0.15);
      font-size: 1.08em;
      letter-spacing: .01em;
      margin-top: 7px;
      margin-bottom: 7px;
    }
    button:hover { transform: translateY(-2px) scale(1.035); }
    #tradeTable { width: 100%; margin-top: 10px; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    #tradeTable th, #tradeTable td { padding: 10px; border: 1px solid #444; text-align: center; }
    #tradeTable thead { background-color: #00ff8833; }
    #tradeTable tbody tr:nth-child(even) { background-color: #2a2a2a; }
    #tradeTable tbody tr:hover { background-color: #333; }
    .card { background: rgba(255,255,255,0.05); border-radius:12px; padding:20px; margin:20px 0; }
    .highlight-card { flex:1; min-width:180px; background: rgba(255,255,255,0.06); padding:15px; border-radius:12px; }
    .highlight-card.best { border-left:5px solid #00ff88; }
    .highlight-card.worst { border-left:5px solid #e74c3c; }
    #goalProgressWrapper { width:100%; background:#333; height:22px; border-radius:12px; overflow:hidden; margin-top:10px; }
    #goalProgress { height:100%; border-radius:12px; line-height:22px; text-align:center; color:#000; font-weight:bold; }
    #stats { margin:8px 0; font-size:1.1em; color:#00ff88; }
    .spinner { border:4px solid #222; border-top:4px solid #00ff88; border-radius:50%; width:22px; height:22px; animation: spin 1s linear infinite; display:inline-block; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .loss { background: rgba(231,76,60,0.08); color: #f1c0bf; }
    .big-win { box-shadow: 0 0 12px rgba(0,255,136,0.18); }
    .sorted-asc::after { content: ' ‚ñ≤'; }
    .sorted-desc::after { content: ' ‚ñº'; }
    #extraControls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
    #toast { position: fixed; right: 20px; bottom: 20px; background: #111; color:#fff; padding:12px 16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.6); display:none; }
    #estCoins { color:#fff; font-weight:800; }
    .theme-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #222;
      color: #00ff88;
      border: 2px solid #00ff88;
      border-radius: 50%;
      padding: 8px 12px;
      font-size: 1.3em;
      cursor: pointer;
      z-index: 999;
    }
    .price-up { background: #d4ffdf !important; color: #2ecc71 !important; transition: background .3s; }
    .price-down { background: #ffd4d4 !important; color: #e74c3c !important; transition: background .3s; }
    .badge { display:inline-block; margin:2px 4px; padding:4px 10px; border-radius:6px; background:#333; color:#fff; font-weight:600;}
    .badge.unlocked { background:#00ff88; color:#222;}
    .badge.locked { background:#aaa;}
    .light-theme {
      background: linear-gradient(145deg, #fdf6f0, #eafff3) !important;
      color: #222 !important;
    }
    .light-theme h1 { background: #ecfff3 !important; color: #00c96d !important; }
    .light-theme .card,
    .light-theme .highlight-card { background: #f4fff8 !important; color: #222 !important; }
    .light-theme #tradeTable th, .light-theme #tradeTable td { border: 1px solid #bbb !important; color: #222 !important; }
    .light-theme .fancy-input, .light-theme .fancy-select { background: #fff !important; color: #222 !important; border-color: #00c96d !important; }
    .light-theme #goalProgressWrapper { background: #eee; }
    .light-theme #goalProgress { color: #222; }
    .light-theme .theme-toggle { background: #eee; color: #00c96d; border-color: #00c96d; }
  </style>
</head>
<body>
<h1>
  EA FC Ultimate Team Coin Tracker
</h1>
    <img src="ChatGPT Image Jun 18, 2025, 02_18_51 PM.png" id="logo" alt="EA Logo">

<div id="tabSwitcher">
  <button id="showTradeBtn" class="tabBtn active">üßæ Trade Tracker</button>
  <button id="showAnalyticsBtn" class="tabBtn">üìä Analytics</button>
</div>

<div id="auth-section">
  <div id="user-info">
    <p id="user-email"></p>
    <button id="logoutBtn" style="display:none">Logout</button>
  </div>
  <button id="loginBtn">Sign in with Google</button>
</div>
<div id="tradeHighlights" style="display:flex; gap:20px; flex-wrap:wrap; margin-top:20px;">
  <div class="highlight-card best">
    <h3>ü•á Best Trade</h3>
    <p id="bestPlayer">-</p>
    <p id="bestProfit">-</p>
    <p id="bestDate">-</p>
  </div>
  <div class="highlight-card worst">
    <h3>üíÄ Worst Trade</h3>
    <p id="worstPlayer">-</p>
    <p id="worstProfit">-</p>
    <p id="worstDate">-</p>
  </div>
</div>

<div id="tradeSection" class="card" style="display:block;">
  <h2>Add New Trade</h2>
  <label class="input-label" for="player">Player or Item Name</label>
  <input id="player" class="fancy-input" placeholder="Player or Item Name">
  <label class="input-label" for="playerRating">Rating</label>
  <input id="playerRating" class="fancy-input" type="number" min="0" max="99" placeholder="Rating">
  <label class="input-label" for="buy">Buy Price</label>
  <input id="buy" class="fancy-input" type="number" min="0" placeholder="Buy Price">
  <label class="input-label" for="sell">Sell Price</label>
  <input id="sell" class="fancy-input" type="number" min="0" placeholder="Sell Price">
  <label class="input-label" for="playerRarity">Player Rarity</label>
  <div id="selectWrapper">
    <select id="playerRarity" class="fancy-select">
      <optgroup label="Gold">
        <option value="gold_rare">Gold Rare üü®</option>
        <option value="gold_common">Gold Common üü®</option>
      </optgroup>
      <optgroup label="Silver">
        <option value="silver_rare">Silver Rare ü™ô</option>
        <option value="silver_common">Silver Common ü™ô</option>
      </optgroup>
      <optgroup label="Bronze">
        <option value="bronze_rare">Bronze Rare üü´</option>
        <option value="bronze_common">Bronze Common üü´</option>
      </optgroup>
      <optgroup label="Special">
        <option value="tots">TOTS üåü</option>
        <option value="toty">TOTY üåü</option>
        <option value="FBD">FUT BIRTHDAY üéâ</option>
        <option value="FFS">FUT FANTASY ‚ú®</option>
        <option value="FUTTIES">FUTTIES üéÄ</option>
        <option value="totyH">TOTY H üèÜ</option>
        <option value="totw">TOTW</option>
      </optgroup>
    </select>
  </div>
  <button id="addBtn">Add Trade</button>
  <p id="streakDisplay">Streaks loading... <span class="spinner"></span></p>
  <div id="stats-section">
    <div id="stats"></div>
    <div id="loss-recovery"></div>
  </div>
  <div id="extraControls">
    <input id="searchInput" type="text" class="fancy-input" placeholder="Search player name..." style="max-width:360px;">
    <select id="rarityFilter" class="fancy-select" style="max-width:220px;">
      <option value="all">All rarities</option>
      <option value="gold">Gold</option>
      <option value="silver">Silver</option>
      <option value="bronze">Bronze</option>
      <option value="special">Special</option>
    </select>
    <input id="minRating" class="fancy-input" type="number" min="0" max="99" placeholder="min rating" style="max-width:120px;">
    <input id="maxRating" class="fancy-input" type="number" min="0" max="99" placeholder="max rating" style="max-width:120px;">
  </div>
  <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px;">
    <button id="exportCsvBtn">Export CSV</button>
    <div>
      <label class="input-label" for="startingCoins">Starting Coins (est)</label>
      <input id="startingCoins" type="number" class="fancy-input" placeholder="0" style="max-width:180px;">
      <button id="saveStartingBtn" style="margin-left:6px;">Save</button>
    </div>
    <div style="margin-left:auto; text-align:right;">
      <div>Estimated coins now: <span id="estCoins">-</span></div>
    </div>
  </div>
  <table id="tradeTable">
    <thead>
      <tr>
        <th data-col="player">Player</th>
        <th data-col="rarity">Rarity</th>
        <th data-col="rating">Rating</th>
        <th data-col="buy">Buy</th>
        <th data-col="sell">Sell</th>
        <th data-col="profit">Profit</th>
        <th data-col="note">Note</th>
        <th data-col="market">Market</th>
        <th data-col="action">Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="comingSoonCard" class="card">
  <div style="font-size:3em; flex-shrink:0; animation: hypePop 1.4s infinite alternate;">üî•</div>
  <div>
    <h2 style="font-weight:900; font-size:2em; margin:0 0 10px 0; color:#00c96d; letter-spacing:1px;">New Rarity Tier Coming Soon!</h2>
    <p style="font-size:1.13em; font-weight:500; margin:0 0 10px 0;">Get ready for <span style="background:#fff176; color:#222; border-radius:5px; padding:3px 8px;">EXCLUSIVE</span> cards!</p>
  </div>
</div>

<div id="analyticsSection" class="card" style="display:none;">
  <h2>üìà Profit Chart</h2>
  <canvas id="profitChart" width="400" height="200"></canvas>
  <h2>üìä Monthly Profit Analytics</h2>
  <canvas id="monthlyChart" width="400" height="200"></canvas>
  <h2>üèÖ Achievements</h2>
  <div id="badges"></div>
</div>
<section id="suggestionsSection" style="margin:20px; padding:10px; background:#121212; border-radius:8px; color:#eee;">
  <h2>üí° Smart Suggestions</h2>
  <div id="suggestionsList"></div>
</section>
<div class="card">
  <h3>üéØ Monthly Profit Goal</h3>
  <label class="input-label" for="profitGoalInput">Set your goal (coins)</label>
  <input type="number" id="profitGoalInput" class="fancy-input" min="1" placeholder="Set your goal (coins)">
  <button id="setGoalBtn">Save Goal</button>
  <p id="goalStatus">Current Goal: -</p>
  <div id="goalProgressWrapper"><div id="goalProgress">0%</div></div>
</div>
<div id="toast"></div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBH9OtMF64mpkrWCHWH4fUr7FzELGlqiD8",
    authDomain: "mysterioustradertool.firebaseapp.com",
    projectId: "mysterioustradertool",
    storageBucket: "mysterioustradertool.appspot.com",
    messagingSenderId: "208262367037",
    appId: "1:208262367037:web:feabcfd9b74dec6eb36754"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let trades = [];
  let userId = null;
  let chart, monthlyChart;
  let profitGoal = null;
  let goalReached = false;
  let achievements = { firstTrade:false, tenTrades:false, bigProfit:false, streakFive:false, goalMaster:false };
  let bestStreak = parseInt(localStorage.getItem('bestStreak') || 0);
  let lossRecovery = null;

  function timeAgo(iso) {
    if (!iso) return '-';
    const diff = Date.now() - new Date(iso).getTime();
    const sec = Math.floor(diff/1000);
    if (sec < 60) return `${sec}s ago`;
    const min = Math.floor(sec/60);
    if (min < 60) return `${min}m ago`;
    const hr = Math.floor(min/60);
    if (hr < 24) return `${hr}h ago`;
    const days = Math.floor(hr/24);
    if (days < 30) return `${days}d ago`;
    return new Date(iso).toLocaleDateString();
  }

  function showToast(msg, ms=3000) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(()=> t.style.display = 'none', ms);
  }

  function calcProfit(buy, sell) { return Math.round(sell * 0.95 - buy); }

  function animateValue(el, start, end, duration=600) {
    const range = end - start;
    let startTime = null;
    function step(ts) {
      if(!startTime) startTime = ts;
      const progress = Math.min((ts - startTime) / duration, 1);
      el.textContent = Math.round(start + range * progress);
      if (progress < 1) window.requestAnimationFrame(step);
    }
    window.requestAnimationFrame(step);
  }

  function rarityGroup(r) {
    if (!r) return 'other';
    if (r.includes('gold')) return 'gold';
    if (r.includes('silver')) return 'silver';
    if (r.includes('bronze')) return 'bronze';
    return 'special';
  }

  // Table rendering with IDs for live price
  function updateTable(list = trades) {
    const tbody = document.querySelector('#tradeTable tbody');
    tbody.innerHTML = '';
    let totalProfit = 0;
    list.forEach((t,i) => {
      const profit = calcProfit(t.buy,t.sell);
      totalProfit += profit;
      const tr = document.createElement('tr');
      tr.id = `trade-${i}`;
      if (profit < 0) tr.classList.add('loss');
      if (profit >= 10000) tr.classList.add('big-win');
      tr.innerHTML = `
        <td>${t.player}</td>
        <td>${formatRarity(t.rarity)}</td>
        <td>${t.rating||'-'}</td>
        <td>${t.buy}</td>
        <td class="sell-price">${t.sell}</td>
        <td style="color:${profit>=0?'#2ecc71':'#e74c3c'}; font-weight:${Math.abs(profit)>=10000?'bold':'normal'}">${profit}</td>
        <td>${getNote(profit)}</td>
        <td>${t.futbinPrice?`Market: <b>${t.futbinPrice} ü™ô</b>`:'Market: <span style="color:#999">N/A</span>'}</td>
        <td>
          <button class="modifyBtn" data-index="${i}">‚úèÔ∏è Modify</button>
          <button class="deleteBtn" data-index="${i}">‚ùå Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    updateGoalProgress(totalProfit);
    updateHighlights();
    updateChart(list);
    updateMonthlyChart(list);
    updateSuggestionsUI();
    updateAchievements();
    document.querySelectorAll('.deleteBtn').forEach(btn => btn.onclick = () => {
      const idx = parseInt(btn.dataset.index);
      trades.splice(idx,1);
      saveTradesToDB(); updateTable(); showToast('Trade deleted');
    });
    document.querySelectorAll('.modifyBtn').forEach(btn => btn.onclick = () => {
      const idx = parseInt(btn.dataset.index); const trade = trades[idx];
      document.getElementById('player').value = trade.player;
      document.getElementById('buy').value = trade.buy;
      document.getElementById('sell').value = trade.sell;
      document.getElementById('playerRating').value = trade.rating||'';
      document.getElementById('playerRarity').value = trade.rarity||'gold_rare';
      const addBtn = document.getElementById('addBtn'); addBtn.textContent = 'Save Changes'; addBtn.dataset.editingIndex = idx;
    });
    const statsEl = document.getElementById('stats');
    statsEl.textContent = `Total Trades: ${trades.length} | Total Profit: ${totalProfit} coins | Avg Profit: ${trades.length?Math.round(totalProfit/trades.length):0} coins`;
    statsEl.dataset.total = totalProfit;
    const start = parseInt(localStorage.getItem('startingCoins')||'0');
    document.getElementById('estCoins').textContent = start + totalProfit;
  }

  function formatRarity(rarity) {
    if (!rarity) return '-';
    let formatted = rarity.replace('_',' ');
    return formatted.charAt(0).toUpperCase() + formatted.slice(1);
  }
  function getNote(profit) {
    if (profit >= 10000) return "üî• Great";
    if (profit >= 0) return "üëç Not Bad";
    return "üíÄ Messed Up";
  }
  function updateHighlights() {
    if (!trades.length) return;
    let best = trades[0], worst = trades[0];
    trades.forEach(t => {
      if (calcProfit(t.buy,t.sell) > calcProfit(best.buy,best.sell)) best = t;
      if (calcProfit(t.buy,t.sell) < calcProfit(worst.buy,worst.sell)) worst = t;
    });
    document.getElementById('bestPlayer').textContent = best.player;
    document.getElementById('bestProfit').textContent = `+${calcProfit(best.buy,best.sell)} ü™ô`;
    document.getElementById('bestDate').textContent = timeAgo(best.date);
    document.getElementById('worstPlayer').textContent = worst.player;
    document.getElementById('worstProfit').textContent = `${calcProfit(worst.buy,worst.sell)} ü™ô`;
    document.getElementById('worstDate').textContent = timeAgo(worst.date);
  }

  function applyFilters() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    const rarity = document.getElementById('rarityFilter').value;
    const minR = parseInt(document.getElementById('minRating').value) || 0;
    const maxR = parseInt(document.getElementById('maxRating').value) || 99;
    const filtered = trades.filter(t => {
      if (q && !t.player.toLowerCase().includes(q)) return false;
      const rg = rarityGroup(t.rarity);
      if (rarity !== 'all') {
        if (rarity === 'special' && rg === 'special') {} else if (rarity !== rg) return false;
      }
      const r = t.rating||0; if (r < minR || r > maxR) return false;
      return true;
    });
    updateTable(filtered);
  }

  let currentSort = {col:null, dir:1};
  document.querySelectorAll('#tradeTable thead th').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const col = th.dataset.col; if (!col) return;
      if (currentSort.col === col) currentSort.dir *= -1; else { currentSort.col = col; currentSort.dir = 1; }
      document.querySelectorAll('#tradeTable thead th').forEach(x => x.classList.remove('sorted-asc','sorted-desc'));
      th.classList.add(currentSort.dir === 1 ? 'sorted-asc':'sorted-desc');
      const sorted = [...trades].sort((a,b)=> {
        let va = (col==='profit') ? calcProfit(a.buy,a.sell) : (a[col]===undefined? '': (typeof a[col] === 'string'? a[col].toLowerCase(): a[col]));
        let vb = (col==='profit') ? calcProfit(b.buy,b.sell) : (b[col]===undefined? '': (typeof b[col] === 'string'? b[col].toLowerCase(): b[col]));
        if (va < vb) return -1 * currentSort.dir; if (va > vb) return 1 * currentSort.dir; return 0;
      });
      updateTable(sorted);
    });
  });

  document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);

  function exportCsv() {
    if (!trades.length) return showToast('No trades to export');
    const headers = ['player','rarity','rating','buy','sell','profit','date'];
    const rows = trades.map(t => [t.player, t.rarity, t.rating||'', t.buy, t.sell, calcProfit(t.buy,t.sell), t.date||'']);
    const csv = [headers.join(','), ...rows.map(r => r.map(cell => '"'+String(cell).replace(/"/g,'""')+'"').join(','))].join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'trades.csv'; a.click(); URL.revokeObjectURL(url);
    showToast('Exported trades.csv');
  }

  document.getElementById('saveStartingBtn').addEventListener('click', () => {
    const val = parseInt(document.getElementById('startingCoins').value) || 0; localStorage.setItem('startingCoins', String(val)); showToast('Starting coins saved'); updateTable();
  });
  document.getElementById('startingCoins').value = localStorage.getItem('startingCoins') || '';

  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('rarityFilter').addEventListener('change', applyFilters);
  document.getElementById('minRating').addEventListener('input', applyFilters);
  document.getElementById('maxRating').addEventListener('input', applyFilters);

  // --- FUTBIN stub and chart functions ---
  const futbinMap = { "Kylian Mbapp√©":23, "Cristiano Ronaldo":20801, "Lionel Messi":158023, "Erling Haaland":241462 };
  async function getFutbinPrice(playerId) {
    // This is a stub. Actual scraping from futbin.com is unreliable due to CORS.
    // Replace with your own backend proxy if needed!
    return null;
  }
  async function getTradePlayerPrice(playerName) { const playerId = futbinMap[playerName]; if (!playerId) return null; return await getFutbinPrice(playerId); }

  function updateChart(list = trades) {
    const ctx = document.getElementById('profitChart').getContext('2d');
    const labels = list.map((t,i)=>`${i+1}. ${t.player}`);
    const profits = list.map(t=>calcProfit(t.buy,t.sell));
    if (chart) chart.destroy();
    chart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Profit per Trade', data:profits, borderColor:'#00ff88', backgroundColor:'rgba(0,255,136,0.1)', pointBackgroundColor:profits.map(p=>p>=0?'#00ff88':'#e74c3c') }] }, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
  }

  function updateMonthlyChart(list = trades) {
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyData = {};
    list.forEach(t=>{
      const profit = calcProfit(t.buy,t.sell);
      const date = t.date ? new Date(t.date) : new Date();
      const key = date.toLocaleString('default',{month:'short', year:'numeric'});
      if(!monthlyData[key]) monthlyData[key]=0;
      monthlyData[key]+=profit;
    });
    const labels = Object.keys(monthlyData); const data = Object.values(monthlyData);
    if (monthlyChart && typeof monthlyChart.destroy === 'function') monthlyChart.destroy();
    monthlyChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Monthly Profit', data, backgroundColor:data.map(p=>p>=0? '#00ff88':'#e74c3c'), borderRadius:4 }] }, options:{ scales:{y:{beginAtZero:true}} } });
  }

  function saveTradesToDB() { if (!userId) return; db.collection('users').doc(userId).set({ trades, profitGoal, achievements }).catch(err=>console.warn('Save failed',err)); }
  function loadTradesFromDB() { if (!userId) return; db.collection('users').doc(userId).get().then(doc=>{ if (doc.exists) { const data = doc.data(); trades = (data.trades||[]).map(t=>({ ...t, rarity:t.rarity||'gold_rare' })); profitGoal = data.profitGoal||null; achievements = data.achievements||achievements; updateTable(); } else { trades=[]; updateTable(); } }); }

  document.getElementById('addBtn').onclick = async () => {
    const player = document.getElementById('player').value.trim();
    const buy = parseInt(document.getElementById('buy').value);
    const sell = parseInt(document.getElementById('sell').value);
    const ratingInput = document.getElementById('playerRating').value; const rating = ratingInput ? parseInt(ratingInput) : null;
    const rarity = document.getElementById('playerRarity').value;
    if (!player || isNaN(buy) || isNaN(sell)) return alert('Please fill all fields');
    const addBtn = document.getElementById('addBtn'); const editingIndex = addBtn.dataset.editingIndex;
    let futbinPrice = null; if (futbinMap[player]) futbinPrice = await getTradePlayerPrice(player);
    const tradeObj = { player, buy, sell, rating, rarity, futbinPrice, date: new Date().toISOString() };
    // Add playerId for live price fetching if available
    if (futbinMap[player]) tradeObj.playerId = futbinMap[player];
    if (editingIndex !== undefined) {
      trades[editingIndex] = { ...tradeObj, date: trades[editingIndex].date || tradeObj.date };
      delete addBtn.dataset.editingIndex; addBtn.textContent = 'Add Trade';
    } else {
      trades.push(tradeObj);
    }
    saveTradesToDB(); updateTable(); updateStreaks(); updateBadges();
    document.getElementById('player').value = ''; document.getElementById('buy').value = ''; document.getElementById('sell').value = ''; document.getElementById('playerRating').value = '';
    showToast('Trade saved');
  };

  document.getElementById('setGoalBtn').onclick = () => {
    const input = parseInt(document.getElementById('profitGoalInput').value);
    if (isNaN(input) || input <= 0) return alert('Enter a valid positive number.');
    profitGoal = input; document.getElementById('goalStatus').textContent = `Current Goal: ${profitGoal} coins`; saveTradesToDB(); updateTable(); updateGoalProgress(trades.reduce((sum,t)=> sum + calcProfit(t.buy,t.sell),0));
  };

  document.getElementById('loginBtn').addEventListener('click', ()=>{ const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(error=> alert('Login failed: '+error)); });
  document.getElementById('logoutBtn').addEventListener('click', ()=> auth.signOut());

  auth.onAuthStateChanged(user=>{ if (user) { userId = user.uid; document.getElementById('loginBtn').style.display = 'none'; document.getElementById('logoutBtn').style.display = 'inline-block'; document.getElementById('user-email').textContent = user.email; loadTradesFromDB(); } else { userId = null; document.getElementById('loginBtn').style.display = ''; document.getElementById('logoutBtn').style.display = 'none'; document.getElementById('user-email').textContent = ''; trades=[]; updateTable(); } });

  document.getElementById('showTradeBtn').onclick = ()=> switchTab(true); document.getElementById('showAnalyticsBtn').onclick = ()=> switchTab(false);

  function updateGoalProgress(totalProfit) {
    if (!profitGoal || profitGoal <= 0) { document.getElementById('goalProgress').style.width='0%'; document.getElementById('goalProgress').textContent='0%'; return; }
    let pct = Math.min(100, Math.round((totalProfit / profitGoal) * 100));
    document.getElementById('goalProgress').style.width = pct + '%'; document.getElementById('goalProgress').textContent = pct + '%';
    document.getElementById('goalProgress').style.background = pct >= 100 ? "linear-gradient(90deg,#00ff88,#fff176)" : "linear-gradient(90deg,#00ff88,#222)";
    if (pct >= 100 && !goalReached) { goalReached = true; showConfetti(); achievements.goalMaster = true; updateBadges(); saveTradesToDB(); }
    else if (pct < 100) goalReached = false;
  }

  function showConfetti() {
    const confetti = document.createElement('div');
    confetti.style.position='fixed'; confetti.style.left='50%'; confetti.style.top='25%'; confetti.style.transform='translate(-50%,-50%)'; confetti.style.fontSize='4em'; confetti.textContent='üéâ';
    confetti.style.zIndex=1000; document.body.appendChild(confetti);
    setTimeout(()=>{confetti.remove();},1800);
  }

  function updateSuggestionsUI() {
    const el = document.getElementById('suggestionsList'); if (!trades.length) { el.innerHTML = '<em>Add some trades to see smart suggestions!</em>'; return; }
    let maxProfitTrade = trades.reduce((a,b)=> calcProfit(a.buy,a.sell) > calcProfit(b.buy,b.sell) ? a : b, trades[0]);
    let minProfitTrade = trades.reduce((a,b)=> calcProfit(a.buy,a.sell) < calcProfit(b.buy,b.sell) ? a : b, trades[0]);
    let avgProfit = trades.length ? Math.round(trades.reduce((s,t)=> s + calcProfit(t.buy,t.sell),0)/trades.length) : 0;
    el.innerHTML = `<div><b>Best trade:</b> ${maxProfitTrade.player} (+${calcProfit(maxProfitTrade.buy,maxProfitTrade.sell)}ü™ô)<br><b>Worst trade:</b> ${minProfitTrade.player} (${calcProfit(minProfitTrade.buy,minProfitTrade.sell)}ü™ô)<br><b>Average profit:</b> ${avgProfit}ü™ô</div>`;
  }

  function updateAchievements() {
    achievements.firstTrade = trades.length >= 1;
    achievements.tenTrades = trades.length >= 10;
    achievements.bigProfit = trades.some(t=> calcProfit(t.buy,t.sell) >= 10000);
    let streak=0, maxStreak=0; trades.forEach(t=>{ if (calcProfit(t.buy,t.sell) > 0) { streak +=1; maxStreak = Math.max(maxStreak, streak); } else streak =0; }); achievements.streakFive = maxStreak >=5;
    updateBadges();
  }

  function updateBadges() {
    const b = document.getElementById('badges');
    b.innerHTML = '';
    b.innerHTML += `<span class="badge ${achievements.firstTrade? 'unlocked':'locked'}">First Trade</span>`;
    b.innerHTML += `<span class="badge ${achievements.tenTrades? 'unlocked':'locked'}">10 Trades</span>`;
    b.innerHTML += `<span class="badge ${achievements.bigProfit? 'unlocked':'locked'}">Big Profit</span>`;
    b.innerHTML += `<span class="badge ${achievements.streakFive? 'unlocked':'locked'}">5 Win Streak</span>`;
    b.innerHTML += `<span class="badge ${achievements.goalMaster? 'unlocked':'locked'}">Goal Master</span>`;
  }

  function updateStreaks() {
    if (!trades.length) { document.getElementById('streakDisplay').textContent = 'No trades yet!'; return; }
    let streak=0,maxStreak=0;
    trades.forEach(t=>{
      if (calcProfit(t.buy,t.sell) > 0) { streak +=1; maxStreak = Math.max(maxStreak, streak); } else streak =0;
    });
    document.getElementById('streakDisplay').textContent = `Current Win Streak: ${streak} | Best Win Streak: ${bestStreak}`;
    updateStreakChallenge(streak);
  }

  function updateStreakChallenge(currentStreak) {
    if (currentStreak > bestStreak) {
      bestStreak = currentStreak;
      localStorage.setItem('bestStreak', bestStreak);
      if ([5, 10, 20].includes(currentStreak)) showToast(`üî• Streak Milestone: ${currentStreak} profitable trades in a row!`);
    }
  }

  // Loss Recovery Tracker
  function checkLossRecovery(profit) {
    if (profit < 0) {
      lossRecovery = { remaining: Math.abs(profit), recovered: 0 };
    } else if (lossRecovery) {
      lossRecovery.recovered += profit;
      if (lossRecovery.recovered >= lossRecovery.remaining) {
        showToast('‚úÖ Loss fully recovered!');
        lossRecovery = null;
      }
    }
    updateLossRecoveryUI();
  }
  function updateLossRecoveryUI() {
    let el = document.getElementById('loss-recovery');
    if (!el) return;
    el.innerText = lossRecovery ? `Loss Recovery: +${lossRecovery.recovered} / Needed ${lossRecovery.remaining}` : 'No losses to recover.';
  }

  document.getElementById('searchInput').addEventListener('keydown', e=>{ if (e.key==='Enter') applyFilters(); });

  updateTable(); updateChart(); updateMonthlyChart(); updateSuggestionsUI(); updateStreaks(); updateBadges();

  window.onload = function() { let showTrade = localStorage.getItem('showTradeTab') !== 'false'; switchTab(showTrade); };
  function switchTab(showTrade) {
    document.getElementById('tradeSection').style.display = showTrade ? 'block' : 'none';
    document.getElementById('analyticsSection').style.display = showTrade ? 'none' : 'block';
    localStorage.setItem('showTradeTab', showTrade ? 'true' : 'false');
  }

  // === 1. Live Prices (FUTNext API) ===
  function fetchLivePrices() {
    trades.forEach((trade, index) => {
      if (!trade.playerId) return;
      fetch(`https://futnext.app/api/player/${trade.playerId}`)
        .then(res => res.json())
        .then(data => {
          let newPrice = data.price;
          let cell = document.querySelector(`#trade-${index} .sell-price`);
          if (!cell) return;
          let oldPrice = parseInt(cell.innerText);
          cell.innerText = newPrice;
          if (newPrice > oldPrice) cell.classList.add('price-up');
          else if (newPrice < oldPrice) cell.classList.add('price-down');
          setTimeout(() => cell.classList.remove('price-up', 'price-down'), 1500);
        })
        .catch(()=>{});
    });
  }
  setInterval(fetchLivePrices, 600000); // every 10 min

  // === 2. Theme Switcher ===
  const themeToggle = document.createElement('button');
  themeToggle.innerText = 'üåô/‚òÄÔ∏è';
  themeToggle.classList.add('theme-toggle');
  themeToggle.onclick = () => {
    document.body.classList.toggle('light-theme');
    localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
  };
  document.body.appendChild(themeToggle);
  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-theme');
</script>
</body>
</html>















